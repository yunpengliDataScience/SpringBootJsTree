<!-- index.html -->
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jstree@3.3.12/dist/themes/default/style.min.css" />
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.4.1/css/all.css" integrity="sha384-5sAR7xN1Nv6T6+dT2mhtzEpVJvfS3NScPQTrOxhwjIuvcA67KV2R5Jz6kr4abQsz" crossorigin="anonymous">
        
</head>
<body>
	
<div class="container">
  <div class="row">
    <!-- Left: Tree -->
    <div class="col-md-5">
      <h5>Tree Structure</h5>
      <div id="jstree"></div>
    </div>

    <!-- Right: Form -->
    <div class="col-md-5">
      <h5>Node Form</h5>
      
      <form id="defaultForm" style="display:none;">
        <div class="form-group">
          <label for="nodeName">Node Name:</label>
          <input type="text" class="form-control" id="nodeName">
        </div>
        <div class="form-group">
          <label for="field1Id">Field 1:</label>
          <input type="text" class="form-control" id="field1Id">
        </div>
        <div class="form-group">
          <label for="field2Id">Field 2:</label>
          <input type="text" class="form-control" id="field2Id">
        </div>
        <button type="button" class="btn btn-primary" onclick="saveNodeToDOM()">Save Node to DOM</button>
      </form>
      
      <form id="3fieldsForm" style="display:none;">
        <div class="form-group">
          <label for="typeANodeName">Node Name:</label>
          <input type="text" class="form-control" id="typeANodeName">
        </div>
        <div class="form-group">
          <label for="typeAField1Id">Field 1:</label>
          <input type="text" class="form-control" id="typeAField1Id">
        </div>
        <div class="form-group">
          <label for="typeAField2Id">Field 2:</label>
          <input type="text" class="form-control" id="typeAField2Id">
        </div>
        <div class="form-group">
          <label for="typeAField3Id">Field 3:</label>
          <input type="text" class="form-control" id="typeAField3Id">
        </div>
        <button type="button" class="btn btn-primary" onclick="save3FieldNodeToDOM()">Save Form to DOM</button>
      </form>
      
	  <br/>
	  <br/>
	 <div class="btn-group" role="group">
	  <button type="button" class="btn btn-primary mr-2" onclick="addNode()">Add Child Node</button>
	  <button type="button" class="btn btn-primary mr-2" onclick="deleteNode()">Delete Node</button>
	  <button type="button" class="btn btn-primary mr-2" onclick="saveTree()">Save Tree to DB</button>
	  <button type="button" class="btn btn-primary mr-2" onclick="saveMiniTree()">Save Mini Tree to DB</button>
    </div>
  </div>
</div>
	
	
  <!-- jQuery first -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <!-- Popper.js (required by Bootstrap 4 tooltips) -->
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>

  <!-- Bootstrap 4 JS -->
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

  <!-- jsTree JS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.12/jstree.min.js"></script>

<script>
let selectedNode = null;

$(function () {
  
  /*
  $('#jstree').jstree({
    'core': {
      'check_callback': true,
      'data': [
        { "id": "1", "parent": "#", "text": "Root", "data": { "field1": "field1 value",  "field2": "field2 value"} }
      ]
    }
  });
  */
  
  //Load json tree file when page is loaded.
  initialUrl = "[[@{'/api/tree/loadTree/mini-tree-data.json'}]]";
  
  $.ajax({
    url: initialUrl,
    method: 'GET',
    success: function (data) {
      $('#jstree').jstree({
        'core': {
		  'check_callback': true,
          'data': data
        }
      });
    },
    error: function () {
      alert('Failed to load tree data');
    }
  });
  
  // Expand tree after ready
  $('#jstree').on('ready.jstree', function () {
    $(this).jstree('open_all');
  });

  // Enable Bootstrap tooltips globally
  $('body').tooltip({
    selector: '[data-toggle="node-tooltip"]',
    placement: 'right',
    html: true,
    trigger: 'hover'
  });
  
  //When a node is selected
  $('#jstree').on("select_node.jstree", function (e, nodeData) {
	  
	//nodeData: {node: {…}, selected: Array(1), event: {…}, instance: {…}}
	console.log("Full data object:", nodeData);
	  
    selectedNode = nodeData.node;
    
    nodeType = nodeData.node.data?.type || '';
    
    //alert("nodeType: "+nodeType);
    
    if(nodeType === 'LV1'){
		$('#typeANodeName').val(nodeData.node.text);
    	$('#typeAField1Id').val(nodeData.node.data?.field1 || '');
    	$('#typeAField2Id').val(nodeData.node.data?.field2 || '');
    	$('#typeAField3Id').val(nodeData.node.data?.field3 || '');
    	$('#3fieldsForm').show();
    	$('#defaultForm').hide();
	}else{
		$('#nodeName').val(nodeData.node.text);
    	$('#field1Id').val(nodeData.node.data?.field1 || '');
    	$('#field2Id').val(nodeData.node.data?.field2 || '');
    	$('#defaultForm').show();
    	$('#3fieldsForm').hide();
	}
   
  });
  
  //Tootip
   $('#jstree').on('mouseover', '.jstree-anchor', function () {
      const nodeId = $(this).closest('li').attr('id');
      const tree = $('#jstree').jstree(true);
      const node = tree.get_node(nodeId);

      let tooltipHtml = '';

	  if (node.data && typeof node.data === 'object') {
	    for (const key in node.data) {
	      if (node.data.hasOwnProperty(key)) {
	        tooltipHtml += `<strong>${key}:</strong> ${node.data[key]}<br>`;
	      }
	    }
	  } else {
	    tooltipHtml = 'No data';
	  }

      $(this)
        .attr('data-toggle', 'node-tooltip')
        .attr('data-html', 'true') // Enable HTML
        .attr('title', tooltipHtml)
        .tooltip('dispose')  // Reset tooltip
        .tooltip('show');
    });
  
});

function saveNodeToDOM() {
  const tree = $('#jstree').jstree(true);
  const newText = $('#nodeName').val();
  const newField1 = $('#field1Id').val();
  const newField2 = $('#field2Id').val();

  if (selectedNode) {
    tree.rename_node(selectedNode, newText);
    selectedNode.data = selectedNode.data || {};
    selectedNode.data.field1 = newField1;
    selectedNode.data.field2 = newField2;
  }

  $('#defaultForm').hide();
}

function save3FieldNodeToDOM() {
  const tree = $('#jstree').jstree(true);
  const newText = $('#typeANodeName').val();
  const newField1 = $('#typeAField1Id').val();
  const newField2 = $('#typeAField2Id').val();
  const newField3 = $('#typeAField3Id').val();

  if (selectedNode) {
    tree.rename_node(selectedNode, newText);
    selectedNode.data = selectedNode.data || {};
    selectedNode.data.field1 = newField1;
    selectedNode.data.field2 = newField2;
    selectedNode.data.field3 = newField3;
  }

  $('#3fieldsForm').hide();
}

//Increment LV0 to LV1 or LVn to LVn+1
function incrementLevel(levelStr) {
  const prefix = levelStr.match(/[^\d]+/)[0]; // Extract non-digit part (e.g., 'LV')
  const number = parseInt(levelStr.match(/\d+/)[0]); // Extract number part (e.g., 0)
  return `${prefix}${number + 1}`;
}

function addNode() {
  const tree = $('#jstree').jstree(true);
  if (!selectedNode) {
    alert("Select a node to add a child to.");
    return;
  }

  const newNodeId = Date.now().toString(); // unique ID
  
  parentNodeType = selectedNode.data?.type || '';
  
  nodeObject = {};
  
  //Add different properties for child node based on parent node type 
  if(parentNodeType === 'LV0'){
	  nodeObject = {
		   	id: newNodeId,
    		text: "New Node",
    		data: { field1: "", field2: "", field3: "", "type" : "LV1" }
	  }
  }else{
	  nodeObject = {
		   	id: newNodeId,
    		text: "New Node",
    		data: { field1: "", field2: "", "type" : incrementLevel(parentNodeType) }
	  }
  }
  
  const newNode = tree.create_node(selectedNode, nodeObject);

  if (newNode) {
    //tree.edit(newNode); // allow inline renaming
  }
  
  // Immediately select the newly created node
	if (newNodeId) {
	  // Use setTimeout to ensure the node is created/rendered before selection
	  setTimeout(() => {
	    tree.deselect_all();
	    tree.select_node(newNodeId); // This will fire select_node.jstree
	  }, 0);
	}
}

function deleteNode() {
	
  	const tree = $('#jstree').jstree(true);
	if (selectedNode) {
	    tree.delete_node(selectedNode);
	    selectedNode = null;
	} else {
	    alert('Please select a node to delete.');
	}

}

function saveTree() {
  const fullTree = $('#jstree').jstree(true).get_json('#', { flat: false });
  alert(JSON.stringify(fullTree));
  
  url = "[[@{'/api/tree/saveTree/full-tree-data.json'}]]";

  $.ajax({
    url: url,
    type: 'POST',
    contentType: 'application/json',
    data: JSON.stringify(fullTree),
    success: () => alert("Tree saved successfully!"),
    error: () => alert("Error saving tree.")
  });
}

function saveMiniTree() {
  const fullTree = $('#jstree').jstree(true).get_json('#', { flat: false });
  
  const minimalTree = simplifyTree(fullTree);
  alert(JSON.stringify(minimalTree));
  
  console.log(JSON.stringify(minimalTree, null, 2));

  url = "[[@{'/api/tree/saveTree/mini-tree-data.json'}]]";
  
  $.ajax({
    url: url,
    type: 'POST',
    contentType: 'application/json',
    data: JSON.stringify(minimalTree),
    success: () => alert("Tree saved successfully!"),
    error: () => alert("Error saving tree.")
  });
}

function simplifyTree(fullTreeNodes) {
  return fullTreeNodes.map(node => {
    const simplified = {  //keep id and text fields
      id: node.id,
      text: node.text
    };

    // Include 'data' if it exists
    if (node.data) {
      simplified.data = node.data;
    }

    // Recursively simplify children if they exist
    if (node.children && node.children.length > 0) {
      simplified.children = simplifyTree(node.children);
    }

    return simplified;
  });
}
</script>
</body>
</html>
