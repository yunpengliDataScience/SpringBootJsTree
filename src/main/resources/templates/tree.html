<!-- index.html -->
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jstree@3.3.12/dist/themes/default/style.min.css" />
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.4.1/css/all.css" integrity="sha384-5sAR7xN1Nv6T6+dT2mhtzEpVJvfS3NScPQTrOxhwjIuvcA67KV2R5Jz6kr4abQsz" crossorigin="anonymous">
        
</head>
<body>
	
<div class="container">
  <div class="row">
    <!-- Left: Tree -->
    <div class="col-md-5">
      <h5>Tree Structure</h5>
      <div id="jstree"></div>
    </div>

    <!-- Right: Form -->
    <div class="col-md-5">
      <h5>Node Form</h5>
      
      <form id="editModal" style="display:none;">
        <div class="form-group">
          <label for="nodeText">Node Name:</label>
          <input type="text" class="form-control" id="nodeName">
        </div>
        <div class="form-group">
          <label for="field1">Field 1:</label>
          <input type="text" class="form-control" id="field1Id">
        </div>
        <div class="form-group">
          <label for="field2">Field 2:</label>
          <input type="text" class="form-control" id="field2Id">
        </div>
        <button type="button" class="btn btn-primary" onclick="saveNode()">Save</button>
      </form>
      
      <form id="editModalA" style="display:none;">
        <div class="form-group">
          <label for="nodeText">Node Name:</label>
          <input type="text" class="form-control" id="typeANodeName">
        </div>
        <div class="form-group">
          <label for="typeAField1Id">Field 1:</label>
          <input type="text" class="form-control" id="typeAField1Id">
        </div>
        <div class="form-group">
          <label for="typeAField2Id">Field 2:</label>
          <input type="text" class="form-control" id="typeAField2Id">
        </div>
        <div class="form-group">
          <label for="typeAField3Id">Field 3:</label>
          <input type="text" class="form-control" id="typeAField3Id">
        </div>
        <button type="button" class="btn btn-primary" onclick="saveTypeANode()">Save</button>
      </form>
      
	  <br/>
	  <br/>
	 <div class="btn-group" role="group">
	  <button type="button" class="btn btn-primary mr-2" onclick="addNode()">Add Child Node</button>
	  <button type="button" class="btn btn-primary mr-2" onclick="deleteNode()">Delete Node</button>
	  <button type="button" class="btn btn-primary mr-2" onclick="saveTree()">Save Tree to DB</button>
	  <button type="button" class="btn btn-primary mr-2" onclick="saveMiniTree()">Save Mini Tree to DB</button>
    </div>
  </div>
</div>
	
	
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jstree@3.3.12/dist/jstree.min.js"></script>

<script>
let selectedNode = null;

$(function () {
  
  /*
  $('#jstree').jstree({
    'core': {
      'check_callback': true,
      'data': [
        { "id": "1", "parent": "#", "text": "Root", "data": { "field1": "field1 value",  "field2": "field2 value"} }
      ]
    }
  });
  */
  
  //Load json tree file when page is loaded.
  initialUrl = "[[@{'/api/tree/loadTree/mini-tree-data.json'}]]";
  
  $.ajax({
    url: initialUrl,
    method: 'GET',
    success: function (data) {
      $('#jstree').jstree({
        'core': {
		  'check_callback': true,
          'data': data
        }
      });
    },
    error: function () {
      alert('Failed to load tree data');
    }
  });
  
  // Expand tree after ready
  $('#jstree').on('ready.jstree', function () {
    $(this).jstree('open_all');
  });

  //When a node is selected
  $('#jstree').on("select_node.jstree", function (e, nodeData) {
	  
	//nodeData: {node: {…}, selected: Array(1), event: {…}, instance: {…}}
	console.log("Full data object:", nodeData);
	  
    selectedNode = nodeData.node;
    
    nodeType = nodeData.node.data?.type || '';
    
    //alert("nodeType: "+nodeType);
    
    if(nodeType === 'A'){
		$('#typeANodeName').val(nodeData.node.text);
    	$('#typeAField1Id').val(nodeData.node.data?.field1 || '');
    	$('#typeAField2Id').val(nodeData.node.data?.field2 || '');
    	$('#typeAField3Id').val(nodeData.node.data?.field3 || '');
    	$('#editModalA').show();
    	$('#editModal').hide();
	}else{
		$('#nodeName').val(nodeData.node.text);
    	$('#field1Id').val(nodeData.node.data?.field1 || '');
    	$('#field2Id').val(nodeData.node.data?.field2 || '');
    	$('#editModal').show();
    	$('#editModalA').hide();
	}
   
  });
});

function saveNode() {
  const tree = $('#jstree').jstree(true);
  const newText = $('#nodeName').val();
  const newField1 = $('#field1Id').val();
  const newField2 = $('#field2Id').val();

  if (selectedNode) {
    tree.rename_node(selectedNode, newText);
    selectedNode.data = selectedNode.data || {};
    selectedNode.data.field1 = newField1;
    selectedNode.data.field2 = newField2;
  }

  $('#editModal').hide();
}

function saveTypeANode() {
  const tree = $('#jstree').jstree(true);
  const newText = $('#typeANodeName').val();
  const newField1 = $('#typeAField1Id').val();
  const newField2 = $('#typeAField2Id').val();
  const newField3 = $('#typeAField3Id').val();

  if (selectedNode) {
    tree.rename_node(selectedNode, newText);
    selectedNode.data = selectedNode.data || {};
    selectedNode.data.field1 = newField1;
    selectedNode.data.field2 = newField2;
    selectedNode.data.field3 = newField3;
  }

  $('#editModalA').hide();
}

function addNode() {
  const tree = $('#jstree').jstree(true);
  if (!selectedNode) {
    alert("Select a node to add a child to.");
    return;
  }

  const newNodeId = Date.now().toString(); // unique ID
  const newNode = tree.create_node(selectedNode, {
    id: newNodeId,
    text: "New Node",
    data: { field1: "", field2: "" }
  });

  if (newNode) {
    //tree.edit(newNode); // allow inline renaming
  }
  
  // Immediately select the newly created node
	if (newNodeId) {
	  // Use setTimeout to ensure the node is created/rendered before selection
	  setTimeout(() => {
	    tree.deselect_all();
	    tree.select_node(newNodeId); // This will fire select_node.jstree
	  }, 0);
	}
}

function deleteNode() {
	
  	const tree = $('#jstree').jstree(true);
	if (selectedNode) {
	    tree.delete_node(selectedNode);
	    selectedNode = null;
	} else {
	    alert('Please select a node to delete.');
	}

}

function saveTree() {
  const fullTree = $('#jstree').jstree(true).get_json('#', { flat: false });
  alert(JSON.stringify(fullTree));
  
  url = "[[@{'/api/tree/saveTree/full-tree-data.json'}]]";

  $.ajax({
    url: url,
    type: 'POST',
    contentType: 'application/json',
    data: JSON.stringify(fullTree),
    success: () => alert("Tree saved successfully!"),
    error: () => alert("Error saving tree.")
  });
}

function saveMiniTree() {
  const fullTree = $('#jstree').jstree(true).get_json('#', { flat: false });
  
  const minimalTree = simplifyTree(fullTree);
  alert(JSON.stringify(minimalTree));
  
  console.log(JSON.stringify(minimalTree, null, 2));

  url = "[[@{'/api/tree/saveTree/mini-tree-data.json'}]]";
  
  $.ajax({
    url: url,
    type: 'POST',
    contentType: 'application/json',
    data: JSON.stringify(minimalTree),
    success: () => alert("Tree saved successfully!"),
    error: () => alert("Error saving tree.")
  });
}

function simplifyTree(fullTreeNodes) {
  return fullTreeNodes.map(node => {
    const simplified = {  //keep id and text fields
      id: node.id,
      text: node.text
    };

    // Include 'data' if it exists
    if (node.data) {
      simplified.data = node.data;
    }

    // Recursively simplify children if they exist
    if (node.children && node.children.length > 0) {
      simplified.children = simplifyTree(node.children);
    }

    return simplified;
  });
}
</script>
</body>
</html>
